<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link href="css/index.css" rel="stylesheet">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <title>Product Details</title>
  <style>
    .product-detail {
      border: 1px solid #ccc;
      padding: 15px 20px;
      margin-top: 20px;
      border-radius: 10px;
    }
    .btn {
      margin-top: 10px;
    }
    .product-detail img{
      width: 100%;
      border-radius: 10px;
    }
     .bottom-option{
      background-color: #ccc;
      padding: 8px;
     }
    .bottom-option .btn{
      width: 47%;
      padding: 15px 0px;
      border: 1px solid black;
      border-radius: 10px;
      font-size: 20px;
      font-weight: 600;
    }
    .bottom-option .buy-btn{
      border: 1px solid #2da010;
      background-color: #2da010;
      color: #ccc;
    }
    .bottom-option .add-btn{
      border: 1px solid #f65005;
      background-color: #f65005;
      color: #ccc;
    }
    .product-detail  h3{
      font-size: 4rem;
    }
    .product-detail  p{
      font-size: 2rem;
    }
    .back{
      background-color: #ccc;
      padding: 8px 10px;
      font-size: 24px;
      font-weight: 800;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;

    }
    #checkoutModal {
      background-color: #333;
    }
    #paymentDetails{
      background-color: #333;
    }
    #paymentDetails .modal-dialog{
      margin: 10% auto;
    }
      /* Center the modal vertically */
  #checkoutModal .modal-dialog {
    margin: 0% auto;
    max-width: 500px;
  }

  /* Style the modal box */
  #checkoutModal .modal-content {
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    background-color: #f9f9f9;
  }

  /* Header styling */
  #checkoutModal h4 {
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
  }

  /* Input fields */
  #checkoutModal input,
  #checkoutModal textarea {
    border-radius: 8px;
    border: 1px solid #ccc;
    padding: 10px;
  }

  /* Buttons */
  #checkoutModal .btn-primary {
    background-color: #2da010;
    border-radius: 8px;
  }

  #checkoutModal .btn-secondary {
     background-color:#f65005;
    border-radius: 8px;
  }
    @media screen and (max-width: 425px) {
      .product-detail  h3{
      font-size: 2rem;
    }
    .product-detail  p{
      font-size: 1.3rem;
    }
    .back{
      background-color: #ccc;
      padding: 8px 10px;
      font-size: 24px;
      font-weight: 800;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;

    }
    .product-detail {
      position: relative;
      border: 1px solid #ccc;
      padding: 15px 20px;
      margin-top: 70px;
      margin-bottom: 120px;
      border-radius: 10px;
    }
     .bottom-option .btn{
      width: 47%;
      padding: 10px 0px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
    }
    
    }

  </style>
</head>
<body>
  <div class="back fixed-top">
    <a href="index.html" class="text-dark text-decoration-none">
      <i class='bx bx-arrow-back'></i>
      </a> Back to Products
  </div>
  
  <div class="product-detail mt-5" id="product-detail"></div>
  <div class="bottom-option d-md-none d-block fixed-bottom" id="bottom-option"></div>

  <!-- HTML: Hidden Address Form -->
<!-- Step 1: Address Form -->
<div id="checkoutModal" class="modal" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h4>Enter Delivery Address</h4>
      <input type="text" id="custName" placeholder="Full Name" class="form-control mb-2" />
      <input type="text" id="custPhone" placeholder="Phone Number" class="form-control mb-2" />
      <input type="text" id="custAltPhone" placeholder="Alternate Number" class="form-control mb-2" />
      <input type="text" id="custPincode" placeholder="Pincode" class="form-control mb-2" />
      <textarea id="custAddress" placeholder="Full Address" class="form-control mb-2"></textarea>
      <input type="text" id="custState" placeholder="State" class="form-control mb-2" />
      <input type="text" id="custDistrict" placeholder="District" class="form-control mb-2" />
      <button class="btn btn-primary" onclick="saveAddressAndProceed()">Next</button>
      <button class="btn btn-secondary mt-2" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Step 2: Payment Details -->
<div id="paymentDetails" class="modal" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h4>Payment Details</h4>
      <div id="paymentCard"></div>
      <button class="btn btn-success mt-3" onclick="placeOrderFinal('ONLINE')">Pay Online</button>
      <button class="btn btn-warning mt-2" onclick="placeOrderFinal('COD')">Cash on Delivery</button>
    </div>
  </div>
</div>



  

  <script>
    const params = new URLSearchParams(window.location.search);
const name = decodeURIComponent(params.get('name'));
const price = params.get('price');
const description = decodeURIComponent(params.get('description'));
const quantity = params.get('quantity');
const image = decodeURIComponent(params.get('image'));

if (name && price && image && quantity && description) {
  const container = document.getElementById('product-detail');
  container.innerHTML = `
    <div class="row">
      <div class="col-12 col-md-6 position-relative p-0">
        <img src="${image}" alt="${name}"><br>
        <div class="like-icon">
          <i class='bx bx-heart'></i>
        </div>
      </div>
      <div class="col-12 col-md-6   d-flex flex-column justify-content-between">
        <div>
        <h3 class="px-3 px-md-5" >${name}</h3>
        <p class="px-3 px-md-5">${description}</p>
        <p class="mt-3 px-3 px-md-5"><strong>Price:</strong> $${price}</p>
        <label class="px-3 px-md-5"><strong>Quantity:</strong>
          <input type="number" id="qty-input" value="${quantity}" min="1">
        </label><br>
        </div>
        <div class="bottom-option d-md-block d-block" id="bottom-option"></div>
      </div>
    </div>
  `;

  const container1 = document.getElementById('bottom-option');
  container1.innerHTML = `
    <div class="d-flex flex-row justify-content-between">
      <button class="btn add-btn" onclick="addToCart('${name}', ${price}, 'qty-input', '${image}')">Add to Cart</button>
      <button class="btn buy-btn" onclick="buyNow('${name}', ${price}, 'qty-input')">Buy Now</button>
    </div>
  `;



  // ✅ Attach the event listener for the like button
  const likeIcon = container.querySelector('.like-icon');
  likeIcon.addEventListener('click', function () {
    toggleLike(this);
  });
}
 else {
      document.getElementById('product-detail').textContent = 'Product details missing.';
    }

   // Function to handle Buy Now
function buyNow(productName, price, qtyInputId) {
  const qty = parseInt(document.getElementById(qtyInputId).value) || 1;
  window.currentProduct = { name: productName, price: price, qty: qty };

  // Show address form first
  document.getElementById("checkoutModal").style.display = "block";
}

// Step 1 → Save Address to DB
function saveAddressAndProceed() {
  const addressData = {
    name: document.getElementById("custName").value,
    phone: document.getElementById("custPhone").value,
    altPhone: document.getElementById("custAltPhone").value,
    pincode: document.getElementById("custPincode").value,
    address: document.getElementById("custAddress").value,
    state: document.getElementById("custState").value,
    district: document.getElementById("custDistrict").value
  };

  // Basic validation
  if (!addressData.name || !addressData.phone || !addressData.address) {
    alert("Please fill all required fields.");
    return;
  }

  // Save in DB
const token = localStorage.getItem("token");

// fetch("http://localhost:8080/admin/update-address", 
fetch("https://ecommerce-backend-wnu9.onrender.com/admin/update-address",{
  method: "PUT",
  headers: {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${token}`
  },
  body: JSON.stringify(addressData)
})
  .then(res => {
    if (!res.ok) throw new Error("Failed to save address");
    return res.text();
  })
  .then(msg => console.log(msg))
  .catch(err => alert("Error saving address: " + err.message));
  document.getElementById("checkoutModal").style.display = "none";
 showPaymentDetails()
}

// Step 2 → Show Payment Details Card
function showPaymentDetails() {
  const { name, price, qty } = window.currentProduct;
  const totalAmount = price * qty;

  document.getElementById("paymentCard").innerHTML = `
    <div class="card p-3">
      <p><strong>Product:</strong> ${name}</p>
      <p><strong>Quantity:</strong> ${qty}</p>
      <p><strong>Total Amount:</strong> ₹${totalAmount}</p>
    </div>
  `;
  document.getElementById("paymentDetails").style.display = "block";
}

// Step 3 → Place Order
function placeOrderFinal(paymentType) {
  const { name, price, qty } = window.currentProduct;
  const totalAmount = price * qty;

  if (paymentType === "COD") {
    // fetch("http://localhost:8080/api/orders/save",
    fetch("https://ecommerce-backend-wnu9.onrender.com/api/orders/save", {
      method: "POST",
      headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token")
         },
      credentials: "include",
      body: JSON.stringify({
        productName: name,
        price: price,
        quantity: qty,
        paymentType: "COD",
        status: "PENDING"
      })
    }).then(() => {
      alert("Order placed successfully (COD)!");
      closePayment();
    });
    return;
  }

  // Razorpay Online Payment
  // fetch("http://localhost:8080/api/payment/create-order",
  fetch("https://ecommerce-backend-wnu9.onrender.com/api/payment/create-order",  {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount: totalAmount })
  })
  .then(res => res.json())
  .then(orderData => {
    const options = {
      key: "rzp_test_qoebkgBWvtmZQw", // Razorpay Key
      amount: orderData.amount,
      currency: "INR",
      name: "My Shop",
      description: name,
      order_id: orderData.id,
      handler: function (response) {
        // fetch("http://localhost:8080/api/orders/save",
        fetch("https://ecommerce-backend-wnu9.onrender.com/api/orders/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            productName: name,
            price: price,
            quantity: qty,
            orderId: response.razorpay_order_id,
            paymentId: response.razorpay_payment_id,
            paymentType: "ONLINE",
            status: "PAID"
          })
        }).then(() => {
          alert("Order placed successfully!");
          closePayment();
        });
      },
      theme: { color: "#3399cc" }
    };
    new Razorpay(options).open();
  });
}

function closeModal() {
  document.getElementById("checkoutModal").style.display = "none";
}

function closePayment() {
  document.getElementById("paymentDetails").style.display = "none";
}

// Close modal function
function closeModal() {
  document.getElementById("checkoutModal").style.display = "none";
}

    // Function to handle Add to Cart
    function addToCart(name, price, qtyInputId, image) {
      const quantity = parseInt(document.getElementById(qtyInputId).value) || 1;

      const product = { name, price, quantity, image };

      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart.push(product);
      localStorage.setItem('cart', JSON.stringify(cart));

      alert('Product added to cart!');
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
  <script src="js/index.js" ></script>
</body>
</html>
